@startuml Kien_Truc_He_Thong_Ung_Dung_Ban_Dong_Ho
!theme plain
skinparam backgroundColor #FEFEFE
skinparam defaultFontName Arial
skinparam defaultFontSize 11

title S∆° ƒê·ªì Ki·∫øn Tr√∫c H·ªá Th·ªëng - ·ª®ng D·ª•ng B√°n ƒê·ªìng H·ªì\n(E-commerce Mobile Application)

' ============================================
' LEGEND & STYLING
' ============================================
skinparam component {
    BackgroundColor<<android>> #E3F2FD
    BorderColor<<android>> #1976D2
    BackgroundColor<<php>> #FFF9C4
    BorderColor<<php>> #F57C00
    BackgroundColor<<database>> #C8E6C9
    BorderColor<<database>> #388E3C
    BackgroundColor<<external>> #FFCCBC
    BorderColor<<external>> #D84315
}

skinparam package {
    BackgroundColor #F5F5F5
    BorderColor #616161
    FontStyle bold
}

skinparam database {
    BackgroundColor #C8E6C9
    BorderColor #2E7D32
}

skinparam cloud {
    BackgroundColor #E1F5FE
    BorderColor #0277BD
}

' ============================================
' ACTORS
' ============================================
actor "üë§ User\n(Ng∆∞·ªùi d√πng)\nrole=0" as User #90CAF9
actor "üë®‚Äçüíº Admin\n(Qu·∫£n tr·ªã vi√™n)\nrole=1" as Admin #FFB74D

' ============================================
' CLIENT LAYER - ANDROID APPLICATION
' ============================================
package "üì± CLIENT LAYER\n(Android Application)" as ClientLayer {

    package "Presentation Layer (UI)" as PresentationLayer {
        component "DangNhapActivity\nDangKiActivity\nResetPassActivity" as AuthUI <<android>>
        component "MainActivity\nChiTietActivity\nDienThoaiActivity\nSearchActivity" as ProductUI <<android>>
        component "GioHangActivity\nDatHangActivity\nThanhToanActivity" as CartUI <<android>>
        component "DonHangActivity\nXemDonActivity\nChiTietDonHangActivity" as OrderUI <<android>>
        component "UpdateProfileActivity\nChonVoucherActivity" as UserUI <<android>>
        component "QuanLiActivity\nThemSPActivity\nTonKhoActivity\nThongKeActivity\nQuanLyNguoiDungActivity\nQuanLyVoucherActivity" as AdminUI <<android>>

        note right of AdminUI
            Ch·ªâ hi·ªÉn th·ªã khi
            user.role == 1
        end note
    }

    package "Business Logic Layer" as LogicLayer {
        component "SanPhamMoiAdapter\nGioHangAdapter\nDonHangAdapter\nVoucherAdapter\nNguoiDungAdapter\nTonKhoAdapter" as Adapters <<android>>
        component "EventBus\n(Real-time Updates)" as EventBus <<android>>
    }

    package "Data Layer" as DataLayer {
        component "User\nSanPhamMoi\nGioHang\nDonHang\nVoucher\nChiTietDonHang\nThongKe" as Models <<android>>

        database "PaperDB\n(Local Storage)" as PaperDB {
            folder "user_current" as UserSession
            folder "cached_data" as CacheData
        }

        component "ApiBanHang\n(Retrofit Interface)\n\n40+ API Endpoints" as RetrofitAPI <<android>>
    }
}

' ============================================
' NETWORK LAYER
' ============================================
cloud "üåê Internet\n(HTTP/HTTPS)" as Internet {
    [JSON REST API]
    [Deep Links]
}

' ============================================
' SERVER LAYER - PHP BACKEND
' ============================================
package "üñ•Ô∏è SERVER LAYER\n(PHP Backend)" as ServerLayer {

    package "API Endpoints (REST)" as APILayer {

        component "üîê Authentication APIs" as AuthAPI <<php>> {
            [dangki.php]
            [dangnhap.php]
            [reset_pass.php]
            [verify_otp_reset_pass.php]
        }

        component "üì¶ Product APIs" as ProductAPI <<php>> {
            [getspmoi.php]
            [getloaisp.php]
            [chitiet.php]
            [timkiem.php]
            [insertsp.php]
            [updatesp.php]
            [xoa.php]
        }

        component "üõí Order APIs" as OrderAPI <<php>> {
            [taoDonHang.php]
            [xemdonhang.php]
            [getChiTietDonHang.php]
            [huyDonHang.php]
            [updateorder.php]
        }

        component "üí≥ Payment APIs" as PaymentAPI <<php>> {
            [vnpay_create_payment.php]
            [vnpay_check_status.php]
            [vnpay_return.php]
            [vnpay_continue_payment.php]
            [paypal_create_payment.php]
            [paypal_execute_payment.php]
        }

        component "üë• User Management APIs" as UserAPI <<php>> {
            [getAllUsers.php]
            [updateUserRole.php]
            [deleteUser.php]
            [updateProfile.php]
        }

        component "üéüÔ∏è Voucher APIs" as VoucherAPI <<php>> {
            [getVouchers.php]
            [checkVoucher.php]
            [saveVoucherUsage.php]
        }

        component "üìä Statistics APIs" as StatsAPI <<php>> {
            [thongke.php]
            [thongke_doanhthu.php]
        }

        component "üì¶ Inventory APIs" as InventoryAPI <<php>> {
            [kiemTraTonKho.php]
            [capNhatTonKho.php]
        }
    }

    package "Business Logic & Security" as BusinessLogic {
        component "Validation\n‚Ä¢ Input sanitization\n‚Ä¢ Data validation" as Validation <<php>>
        component "Authentication\n‚Ä¢ Session check\n‚Ä¢ Token verify" as Authentication <<php>>
        component "Authorization\n‚Ä¢ Role check\n‚Ä¢ Permission verify" as Authorization <<php>>
        component "Security\n‚Ä¢ SQL injection prevent\n‚Ä¢ XSS protection" as Security <<php>>
    }

    package "External Libraries" as Libraries {
        component "PHPMailer\n(SMTP Email)" as PHPMailer <<php>>
    }

    package "Database Access Layer" as DBAccess {
        component "MySQLi Driver\n‚Ä¢ Connection pool\n‚Ä¢ Prepared statements\n‚Ä¢ Transaction mgmt" as MySQLi <<php>>
        file "connect.php" as ConnectFile
    }

    package "Configuration Files" as ConfigFiles {
        file "vnpay_config.php" as VNPayConfig
        file "paypal_config.php" as PayPalConfig
        file "email_config.php" as EmailConfig
    }
}

' ============================================
' DATABASE LAYER - MYSQL
' ============================================
package "üóÑÔ∏è DATABASE LAYER\n(MySQL Database)" as DatabaseLayer {

    database "appbandienthoai" as MainDB <<database>> {

        package "Core Tables" as CoreTables {
            entity "user" as UserTable <<database>> {
                * id : INT <<PK>>
                --
                email : VARCHAR(255) <<UNIQUE>>
                pass : VARCHAR(255)
                username : VARCHAR(100)
                mobile : VARCHAR(20)
                **role : INT (0=User, 1=Admin)**
                login_type : ENUM('normal','google')
                account_status : TINYINT
                reset_otp : VARCHAR(10)
                reset_otp_expiry : DATETIME
                created_at : TIMESTAMP
            }

            entity "loaisp" as CategoryTable <<database>> {
                * id : INT <<PK>>
                --
                tensanpham : VARCHAR(255)
                hinhanh : VARCHAR(255)
            }

            entity "sanphammoi" as ProductTable <<database>> {
                * id : INT <<PK>>
                --
                tensp : VARCHAR(255)
                giasp : VARCHAR(100)
                hinhanh : TEXT
                mota : TEXT
                loai : INT <<FK>>
                soluong : INT (ƒë√£ b√°n)
                **soluongtonkho : INT**
                created_at : TIMESTAMP
            }
        }

        package "Transaction Tables" as TransactionTables {
            entity "giohang" as CartTable <<database>> {
                * id : INT <<PK>>
                --
                iduser : INT <<FK>>
                idsp : INT <<FK>>
                tensp : VARCHAR(255)
                giasp : VARCHAR(100)
                hinhanh : TEXT
                soluong : INT
                ngaythem : TIMESTAMP
            }

            entity "donhang" as OrderTable <<database>> {
                * id : INT <<PK>>
                --
                madonhang : VARCHAR(50) <<UNIQUE>>
                iduser : INT <<FK>>
                diachi : TEXT
                sodienthoai : VARCHAR(20)
                soluong : INT
                tongtien : VARCHAR(100)
                ngaydat : DATETIME
                ngaygiaodukien : VARCHAR(100)
                **trangthai : VARCHAR(50)**
                phuongthucthanhtoan : VARCHAR(50)
                vnpay_txn_ref : VARCHAR(100)
                paypal_order_id : VARCHAR(100)
                voucher_id : INT <<FK>>
                ma_voucher : VARCHAR(50)
                gia_tri_giam : DECIMAL(10,2)
                tong_truoc_giam : DECIMAL(10,2)
                lydo_huy : TEXT
            }

            entity "chitietdonhang" as OrderDetailTable <<database>> {
                * id : INT <<PK>>
                --
                iddonhang : INT <<FK>>
                idsp : INT <<FK>>
                soluong : INT
                gia : VARCHAR(100)
            }
        }

        package "Voucher Tables" as VoucherTables {
            entity "voucher" as VoucherTable <<database>> {
                * id : INT <<PK>>
                --
                ma_voucher : VARCHAR(50) <<UNIQUE>>
                ten_voucher : VARCHAR(200)
                mo_ta : TEXT
                loai_giam : ENUM
                gia_tri_giam : DECIMAL(10,2)
                giam_toi_da : DECIMAL(10,2)
                don_toi_thieu : DECIMAL(10,2)
                ap_dung_cho : ENUM
                so_luong : INT
                **da_su_dung : INT**
                gioi_han_moi_user : INT
                ngay_bat_dau : DATETIME
                ngay_het_han : DATETIME
                trang_thai : TINYINT
            }

            entity "voucher_usage" as VoucherUsageTable <<database>> {
                * id : INT <<PK>>
                --
                voucher_id : INT <<FK>>
                user_id : INT <<FK>>
                donhang_id : INT <<FK>>
                ma_donhang : VARCHAR(50)
                gia_tri_don_hang : DECIMAL(10,2)
                gia_tri_giam : DECIMAL(10,2)
                ngay_su_dung : TIMESTAMP
            }
        }

        package "Database Triggers" as Triggers {
            component "üîÑ TRIGGER 1\nafter_chitietdonhang_insert\n_giam_tonkho" as Trigger1 <<database>> {
                note right
                    T·ª± ƒë·ªông gi·∫£m soluongtonkho
                    khi INSERT chitietdonhang

                    UPDATE sanphammoi
                    SET soluongtonkho =
                        soluongtonkho - NEW.soluong
                end note
            }

            component "üîÑ TRIGGER 2\nafter_donhang_update\n_hoan_tonkho" as Trigger2 <<database>> {
                note right
                    Ho√†n t·ªìn kho khi h·ªßy ƒë∆°n
                    IF NEW.trangthai = 'ƒê√£ h·ªßy'

                    UPDATE sanphammoi
                    SET soluongtonkho =
                        soluongtonkho + soluong
                end note
            }

            component "üîÑ TRIGGER 3\nafter_donhang_insert\n_update_voucher" as Trigger3 <<database>> {
                note right
                    TƒÉng voucher ƒë√£ s·ª≠ d·ª•ng
                    IF NEW.voucher_id IS NOT NULL

                    UPDATE voucher
                    SET da_su_dung =
                        da_su_dung + 1
                end note
            }
        }
    }
}

' ============================================
' EXTERNAL SERVICES
' ============================================
package "üåç EXTERNAL SERVICES" as ExternalServices {

    component "VNPay Gateway\n(Sandbox)" as VNPay <<external>> {
        [Payment API]
        [Return URL Handler]
        note bottom
            ‚úÖ Status: ACTIVE
            Deep link:
            appbandienthoai://
            payment_return
        end note
    }

    component "PayPal API\n(REST)" as PayPal <<external>> {
        [Order Creation]
        [Payment Execution]
        note bottom
            ‚ö†Ô∏è Status: INACTIVE
            Code exists but
            not integrated
        end note
    }

    component "Firebase Services" as Firebase <<external>> {
        [Cloud Messaging (FCM)]
        [Authentication]
        [Google Sign-In]
        note bottom
            ‚úÖ Google Auth: Active
            ‚ö†Ô∏è FCM: Setup unused
        end note
    }

    component "Gmail SMTP" as Gmail <<external>> {
        [Email Server]
        [TLS Port 587]
        note bottom
            ‚úÖ OTP Email
            PHPMailer
        end note
    }

    component "Google OAuth 2.0" as GoogleOAuth <<external>> {
        [Identity Provider]
        [Token Validation]
        note bottom
            ‚úÖ Social Login
            Auto create user
            with role=0
        end note
    }
}

' ============================================
' RELATIONSHIPS & DATA FLOW
' ============================================

' User interactions
User --> AuthUI : ƒêƒÉng nh·∫≠p/ƒêƒÉng k√Ω
User --> ProductUI : Xem s·∫£n ph·∫©m
User --> CartUI : Mua h√†ng
User --> OrderUI : Qu·∫£n l√Ω ƒë∆°n
User --> UserUI : C·∫≠p nh·∫≠t th√¥ng tin

Admin --> AdminUI : Qu·∫£n l√Ω h·ªá th·ªëng
Admin --> ProductUI : Xem s·∫£n ph·∫©m
Admin --> OrderUI : Xem t·∫•t c·∫£ ƒë∆°n

' UI to Logic
AuthUI --> Adapters
ProductUI --> Adapters
CartUI --> Adapters
OrderUI --> Adapters
AdminUI --> Adapters

Adapters --> EventBus : Notify changes
EventBus --> AuthUI : Update UI
EventBus --> OrderUI : Update UI

' Logic to Data
Adapters --> Models : Bind data
AuthUI --> RetrofitAPI : API calls
ProductUI --> RetrofitAPI : API calls
CartUI --> RetrofitAPI : API calls
OrderUI --> RetrofitAPI : API calls
AdminUI --> RetrofitAPI : API calls
UserUI --> RetrofitAPI : API calls

Models --> PaperDB : Store locally
RetrofitAPI --> PaperDB : Cache response

' Client to Network
RetrofitAPI --> Internet : HTTP requests
Internet --> RetrofitAPI : JSON response

' Network to Server
Internet --> AuthAPI
Internet --> ProductAPI
Internet --> OrderAPI
Internet --> PaymentAPI
Internet --> UserAPI
Internet --> VoucherAPI
Internet --> StatsAPI
Internet --> InventoryAPI

' API to Business Logic
AuthAPI --> Validation
ProductAPI --> Validation
OrderAPI --> Validation
PaymentAPI --> Validation
UserAPI --> Authorization
VoucherAPI --> Validation
StatsAPI --> Authorization
InventoryAPI --> Authorization

Validation --> Security
Authentication --> Security
Authorization --> Authentication

' Business Logic to DB Access
AuthAPI --> MySQLi
ProductAPI --> MySQLi
OrderAPI --> MySQLi
PaymentAPI --> MySQLi
UserAPI --> MySQLi
VoucherAPI --> MySQLi
StatsAPI --> MySQLi
InventoryAPI --> MySQLi

MySQLi --> ConnectFile : Uses

' DB Access to Database
MySQLi --> UserTable : CRUD
MySQLi --> CategoryTable : CRUD
MySQLi --> ProductTable : CRUD
MySQLi --> CartTable : CRUD
MySQLi --> OrderTable : CRUD
MySQLi --> OrderDetailTable : CRUD
MySQLi --> VoucherTable : CRUD
MySQLi --> VoucherUsageTable : CRUD

' Database Relationships
ProductTable }o--|| CategoryTable : "belongs to"
CartTable }o--|| UserTable : "owned by"
CartTable }o--|| ProductTable : "contains"
OrderTable }o--|| UserTable : "placed by"
OrderTable }o--o| VoucherTable : "uses"
OrderDetailTable }o--|| OrderTable : "details of"
OrderDetailTable }o--|| ProductTable : "contains"
VoucherUsageTable }o--|| VoucherTable : "tracks"
VoucherUsageTable }o--|| UserTable : "used by"
VoucherUsageTable }o--o| OrderTable : "applied to"

' Triggers
Trigger1 .down.> OrderDetailTable : "ON INSERT"
Trigger1 .down.> ProductTable : "UPDATE\nsoluongtonkho"
Trigger2 .down.> OrderTable : "ON UPDATE"
Trigger2 .down.> ProductTable : "UPDATE\nsoluongtonkho"
Trigger3 .down.> OrderTable : "ON INSERT"
Trigger3 .down.> VoucherTable : "UPDATE\nda_su_dung"

' External Services
PaymentAPI --> VNPayConfig : Uses
PaymentAPI --> PayPalConfig : Uses
AuthAPI --> EmailConfig : Uses

PaymentAPI <--> VNPay : Create payment\n& Callback
PaymentAPI <--> PayPal : Create order\n& Execute
AuthAPI --> PHPMailer : Send email
PHPMailer --> Gmail : SMTP
AuthAPI <--> Firebase : Verify token
AuthAPI <--> GoogleOAuth : Authenticate
Firebase -up-> AdminUI : Push notification\n(unused)

' Deep links
VNPay -up-> OrderUI : Deep link\nappbandienthoai://
PayPal -up-> CartUI : Deep link\nappbandienthoai://

' ============================================
' NOTES & ANNOTATIONS
' ============================================
note top of ClientLayer
    **ANDROID APPLICATION**
    ‚Ä¢ Language: Java
    ‚Ä¢ Min SDK: API 24 (Android 7.0)
    ‚Ä¢ Target SDK: API 34 (Android 14)
    ‚Ä¢ Architecture: MVC Pattern

    **Libraries:**
    ‚Ä¢ Retrofit 2.9.0 (HTTP Client)
    ‚Ä¢ RxJava 2.2.21 (Reactive)
    ‚Ä¢ Glide 4.16.0 (Image loading)
    ‚Ä¢ PaperDB 2.7.2 (Local storage)
    ‚Ä¢ EventBus 3.3.1 (Event-driven)
    ‚Ä¢ MPAndroidChart 3.1.0 (Charts)
    ‚Ä¢ Firebase (FCM, Auth)
end note

note top of ServerLayer
    **PHP BACKEND**
    ‚Ä¢ PHP Version: 7.4+
    ‚Ä¢ Server: Apache/Nginx
    ‚Ä¢ 50+ API endpoints
    ‚Ä¢ 8 module groups

    **Security:**
    ‚Ä¢ SQL Injection prevention
    ‚Ä¢ XSS protection
    ‚Ä¢ Role-based access control
    ‚Ä¢ Input validation
    ‚Ä¢ Session management
end note

note top of DatabaseLayer
    **MYSQL DATABASE**
    ‚Ä¢ Version: 5.7+
    ‚Ä¢ Database: appbandienthoai
    ‚Ä¢ 13 tables
    ‚Ä¢ 3 triggers (automation)
    ‚Ä¢ Foreign key constraints
    ‚Ä¢ Unique constraints

    **Total Size:**
    ~43,500 lines of code
    200+ files in project
end note

note bottom of ExternalServices
    **PAYMENT METHODS:**
    ‚úÖ COD (Cash On Delivery)
    ‚úÖ VNPay (Active & Working)
    ‚ö†Ô∏è PayPal (Code exists, not active)

    **AUTHENTICATION:**
    ‚úÖ Email/Password
    ‚úÖ Google Sign-In
    ‚úÖ OTP Reset Password
end note

' ============================================
' LEGEND
' ============================================
legend bottom right
    **LEGEND (Ch√∫ gi·∫£i)**
    |= Color |= Component |
    | <back:#E3F2FD></back> | Android Client |
    | <back:#FFF9C4></back> | PHP Server |
    | <back:#C8E6C9></back> | MySQL Database |
    | <back:#FFCCBC></back> | External Services |

    |= Symbol |= Meaning |
    | ‚Äî‚Üí | Synchronous call |
    | ‚á¢ | Asynchronous call |
    | }o‚Äî|| | Foreign key relationship |
    | .> | Trigger/Event |

    **STATISTICS (Th·ªëng k√™)**
    ‚Ä¢ Activities: 23
    ‚Ä¢ Adapters: 9
    ‚Ä¢ Models: 25+
    ‚Ä¢ API Endpoints: 50+
    ‚Ä¢ Database Tables: 13
    ‚Ä¢ Triggers: 3
    ‚Ä¢ Features: 50+

    **PROJECT INFO**
    Name: ·ª®ng D·ª•ng B√°n ƒê·ªìng H·ªì
    Package: vn.duytruong.appbandienthoai
    Database: appbandienthoai
    Date: 30/11/2025
end legend

@enduml

